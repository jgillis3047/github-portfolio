-- This SQL Code is an original, fictional example created to demonstrate data transformation and view logic for portfolio purposes. All object names and business logic have been generalized and are not based on any real or proprietary system.
create or replace view EXAMPLE_DATABASE.EXAMPLE.VW_EXAMPLE(
ID,
CASEINCIDENT,
STARTDATE
) as
WITH BEGINTAB AS ( 
select companyid,
case when companyDisplacementcode = 120 then 'TRUE'
else 'FALSE' 
end as "Begin Tab Displacement Code"
from EXAMPLE_PROD.EXAMPLE.EXAMPLE
),
BEGINDATE AS (
SELECT C.COMPANYID,
CASE WHEN COMPANYSTATUSID = 4 THEN 'TRUE'
ELSE 'FALSE'
END AS "Company Begin Date Confirmed"
FROM EXAMPLE_PROD.EXAMPLE.EXAMPLE AS C
LEFT JOIN EXAMPLE_PROD.EXAMPLE.EXAMPLE2 AS CT ON C.COMPANYID = CT.COMPANYID
WHERE COMPANYSTATUSID = 3
AND COMPANYINCIDENTID = 125
),
CLOSINGINCIDENT AS (
SELECT DISTINCT ID, 
C.COMPANYID,
CASEINCIDENT,
INCIDENTVALUE AS "Incident Date",
DROPDOWNVALUE AS "Region Type"
FROM EXAMPLE_PROD.EXAMPLE.EXAMPLE AS C
LEFT JOIN EXAMPLE_PROD.EXAMPLE.EXAMPLE2 AS CT ON CT.COMPANYID = C.COMPANYID
LEFT JOIN EXAMPLE_PROD.EXAMPLE.EXAMPLE3 AS CS ON CS.COMPANYSTATUSID = CT.COMPANYSTATUSID
LEFT JOIN EXAMPLE_PROD.EXAMPLE.EXAMPLE4 AS CFT ON CFT.COMPANYINCIDENTTRACKINGID = CT.COMPANYINCIDENTTRACKINGID
LEFT JOIN EXAMPLE_PROD.EXAMPLE.EXAMPLE5 AS CTT ON CTT.COMPANYID = C.COMPANYID
LEFT JOIN EXAMPLE_PROD.EXAMPLE.EXAMPLE6 AS CTTT ON CT.COMPANYINCIDENTTYPEID = CTTT.COMPANYINCIDENTTYPEID
LEFT JOIN EXAMPLE_PROD.EXAMPLE.EXAMPLE7 AS CO ON CO.COMPANYOPTIONID = CT.COMPANYOPTIONID
WHERE CT.COMPANYOPTIONID IN (345)
AND INCIDENTVALUE IS NOT NULL
AND INCIDENTDESCRIPTION = 'Order Provided'
AND CS.INCIDENTSTATUSDESCRIPTION = 'Completed'

), 
CLOSINGINDENTTYPE AS (
SELECT C.COMPANYID,
CASE WHEN C.COMPANYID IN (SELECT RF.COMPANYID FROM CLOSINGINCIDENT AS RF WHERE RF.COMPANYID = C.COMPANYID) THEN 'TRUE'
ELSE 'FALSE'
END AS "Company Incident Provided"
FROM EXAMPLE_PROD.EXAMPLE.EXAMPLE AS C
)
SELECT
    ID,
    CASEINCIDENT,
    STARTDT,
    FROM EXAMPLE_PROD.EXAMPLE.EXAMPLE AS C
LEFT JOIN BEGINTAB ST ON C.COMPANYID = ST.COMPANYID
LEFT JOIN BEGINDATE RD ON C.COMPANYID = RD.COMPANYID 
LEFT JOIN CLOSINGINDENTTYPE CT ON C.COMPANYID = CT.COMPANYID
WHERE COMPANYSTATUSID = 3
AND (
ST."Begin Tab Displacement Code" = 'TRUE' OR 
RD."Company Begin Date Confirmed" = 'TRUE' OR
CT."Company Incident Provided" = 'TRUE'
)
AND NOT (
ST."Begin Tab Displacement Code" = 'TRUE' AND 
RD."Company Begin Date Confirmed" = 'TRUE' AND
CT."Company Incident Provided" = 'TRUE'
);
